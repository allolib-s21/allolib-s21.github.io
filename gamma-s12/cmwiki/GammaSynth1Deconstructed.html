<!DOCTYPE html>
<!-- saved from url=(0068)https://foo.cs.ucsb.edu/cmwiki/index.php/Gamma:_synth1_deconstructed -->
<html lang="en" dir="ltr" class="client-js"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<title>Gamma: synth1 deconstructed - cmwiki</title>
<script>document.documentElement.className = document.documentElement.className.replace( /(^|\s)client-nojs(\s|$)/, "$1client-js$2" );</script>
<script>window.RLQ = window.RLQ || []; window.RLQ.push( function () {
mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":!1,"wgNamespaceNumber":0,"wgPageName":"Gamma:_synth1_deconstructed","wgTitle":"Gamma: synth1 deconstructed","wgCurRevisionId":32,"wgRevisionId":32,"wgArticleId":6,"wgIsArticle":!0,"wgIsRedirect":!1,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":[],"wgBreakFrames":!1,"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"Gamma:_synth1_deconstructed","wgRelevantArticleId":6,"wgIsProbablyEditable":!1,"wgRestrictionEdit":[],"wgRestrictionMove":[],"wgWikiEditorEnabledModules":{"toolbar":!1,"dialogs":!1,"preview":!1,"publish":!1
}});mw.loader.implement("user.options",function($,jQuery){mw.user.options.set({"variant":"en"});});mw.loader.implement("user.tokens",function($,jQuery){mw.user.tokens.set({"editToken":"+\\","patrolToken":"+\\","watchToken":"+\\"});});mw.loader.load(["mediawiki.page.startup","mediawiki.legacy.wikibits","skins.vector.js"]);
} );</script>
<link rel="stylesheet" href="https://foo.cs.ucsb.edu/cmwiki/load.php?debug=false&amp;lang=en&amp;modules=mediawiki.legacy.commonPrint%2Cshared%7Cmediawiki.sectionAnchor%7Cmediawiki.skinning.interface%7Cskins.vector.styles&amp;only=styles&amp;skin=vector">
<style>
.mw-collapsible-toggle{float:right;-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none;user-select:none}  .mw-content-ltr .mw-collapsible-toggle,.mw-content-rtl .mw-content-ltr .mw-collapsible-toggle{float:right} .mw-content-rtl .mw-collapsible-toggle,.mw-content-ltr .mw-content-rtl .mw-collapsible-toggle{float:left}.mw-customtoggle,.mw-collapsible-toggle{cursor:pointer} caption .mw-collapsible-toggle,.mw-content-ltr caption .mw-collapsible-toggle,.mw-content-rtl caption .mw-collapsible-toggle,.mw-content-rtl .mw-content-ltr caption .mw-collapsible-toggle,.mw-content-ltr .mw-content-rtl caption .mw-collapsible-toggle{float:none} li .mw-collapsible-toggle,.mw-content-ltr li .mw-collapsible-toggle,.mw-content-rtl li .mw-collapsible-toggle,.mw-content-rtl .mw-content-ltr li .mw-collapsible-toggle,.mw-content-ltr .mw-content-rtl li .mw-collapsible-toggle{float:none} .mw-collapsible-toggle-li{list-style:none}
.suggestions{overflow:hidden;position:absolute;top:0;left:0;width:0;border:none;z-index:1099;padding:0;margin:-1px 0 0 0}.suggestions-special{position:relative;background-color:white;cursor:pointer;border:solid 1px #aaaaaa;padding:0;margin:0;margin-top:-2px;display:none;padding:0.25em 0.25em;line-height:1.25em}.suggestions-results{background-color:white;cursor:pointer;border:solid 1px #aaaaaa;padding:0;margin:0}.suggestions-result{color:black;margin:0;line-height:1.5em;padding:0.01em 0.25em;text-align:left; overflow:hidden;-o-text-overflow:ellipsis; text-overflow:ellipsis;white-space:nowrap}.suggestions-result-current{background-color:#4C59A6;color:white}.suggestions-special .special-label{color:gray;text-align:left}.suggestions-special .special-query{color:black;font-style:italic;text-align:left}.suggestions-special .special-hover{background-color:silver}.suggestions-result-current .special-label,.suggestions-result-current .special-query{color:white}.highlight{font-weight:bold}
.postedit-container{margin:0 auto;position:fixed;top:0;height:0;left:50%;z-index:1000;font-size:13px}.postedit-container:hover{cursor:pointer}.postedit{position:relative;top:0.6em;left:-50%;padding:.6em 3.6em .6em 1.1em;line-height:1.5625em;color:#626465;background-color:#f4f4f4;border:1px solid #dcd9d9;text-shadow:0 0.0625em 0 rgba(255,255,255,0.5);border-radius:5px;box-shadow:0 2px 5px 0 #ccc;-webkit-transition:all 0.25s ease-in-out;-moz-transition:all 0.25s ease-in-out;-ms-transition:all 0.25s ease-in-out;-o-transition:all 0.25s ease-in-out;transition:all 0.25s ease-in-out}.skin-monobook .postedit{top:6em !important}.postedit-faded{opacity:0}.postedit-icon{padding-left:41px;  line-height:25px;background-repeat:no-repeat;background-position:8px 50%}.postedit-icon-checkmark{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAABblBMVEUAAAD///////9PfTf///80aRdTgjn///9Feij///////////9Rfzf///////////9PfjZRgDh1o1xOfTb///////+bwYqLtnj///////9PfTa82K////9WhT6YxIL///9QgDdTgzr////////j7uDl7eLq8efi693k7OH///////9UhjuBr2rp9uRUhjr///9YljVKgir///9WiTlYjT3////9/v57vFlbkT5PjC9dlD/5/fhuq09stUTs9uhxuElctCpfnT1huDFloEZloUZmpENmvDZpvDxpvTxqvjxrvT5rvT9rwTxsqktswD5uwkBvuUdxw0NztFBztU9ztVBzwkp0tlJ1xkd2t1R3uVR4w1F4xk54x014yE15uVZ5v1R5xVB6v1R7yFJ8wVh9xVl9yFR9yVd9ylN+xVh+yFd/x1l/yFeAylmEx1+Ny2uY0Hqe04Wj1Ymv3Ze33qLD47TJ5L3O6cPU7Mrq9eb2+/Q4j37OAAAAQHRSTlMAAQIEBAUFBQwPFB4fJCUoKiosQEhJS01RUlZZXmdydXaChYuSlJSWmJmoq6uur8LExcvM19fg5ejt8fX2+Pr7SljgewAAAKpJREFUGBkFwQNCAwAAAMDLtl3LtrG4rWXbtvX77gAgZ6grFwC0bhwNVgKgdPZx8b0dgLi+s7Wn0VoAqpfOI9+BNADZI7fLrz2pSEwGHZuH+78lSK8ZLkLezF3ooyUG3VPXq2USei9WngeyoG195yBYWDF3E/2pAhl1e9Gr8bGT+bfOFCC2fnvh4X7rcqIAQNNu+HT6sxkAjceTL/2ZAIhv+PorBwBJxfkA//dFHSCBy/UTAAAAAElFTkSuQmCC);background-image:url(https://foo.cs.ucsb.edu/cmwiki/resources/src/mediawiki.action/images/green-checkmark.png?9048a)!ie;background-position:left}.postedit-close{position:absolute;padding:0 .8em;right:0;top:0;font-size:1.25em;font-weight:bold;line-height:2.3em;color:black;text-shadow:0 0.0625em 0 white;text-decoration:none;opacity:0.2;filter:alpha(opacity=20)}.postedit-close:hover{color:black;text-decoration:none;opacity:0.4;filter:alpha(opacity=40)}</style><style>
.suggestions a.mw-searchSuggest-link,.suggestions a.mw-searchSuggest-link:hover,.suggestions a.mw-searchSuggest-link:active,.suggestions a.mw-searchSuggest-link:focus{color:black;text-decoration:none}.suggestions-result-current a.mw-searchSuggest-link,.suggestions-result-current a.mw-searchSuggest-link:hover,.suggestions-result-current a.mw-searchSuggest-link:active,.suggestions-result-current a.mw-searchSuggest-link:focus{color:white}.suggestions a.mw-searchSuggest-link .special-query{ overflow:hidden;-o-text-overflow:ellipsis; text-overflow:ellipsis;white-space:nowrap}</style><meta name="ResourceLoaderDynamicStyles" content="">
<link rel="stylesheet" href="https://foo.cs.ucsb.edu/cmwiki/load.php?debug=false&amp;lang=en&amp;modules=site&amp;only=styles&amp;skin=vector">
<style>a:lang(ar),a:lang(kk-arab),a:lang(mzn),a:lang(ps),a:lang(ur){text-decoration:none}</style>
<script async="" src="https://foo.cs.ucsb.edu/cmwiki/load.php?debug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=vector"></script>
<meta name="generator" content="MediaWiki 1.26.2">
<link rel="shortcut icon" href="https://foo.cs.ucsb.edu/cmwiki/LocalImages/cmwiki_128x128px.png">
<link rel="search" type="application/opensearchdescription+xml" href="https://foo.cs.ucsb.edu/cmwiki/opensearch_desc.php" title="cmwiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://foo.cs.ucsb.edu/cmwiki/api.php?action=rsd">
<link rel="alternate" type="application/atom+xml" title="cmwiki Atom feed" href="https://foo.cs.ucsb.edu/cmwiki/index.php?title=Special:RecentChanges&amp;feed=atom">
<!--[if lt IE 7]><style type="text/css">body{behavior:url("/cmwiki/skins/Vector/csshover.min.htc")}</style><![endif]-->
<script src="https://foo.cs.ucsb.edu/cmwiki/load.php?debug=false&amp;lang=en&amp;modules=jquery%2Cmediawiki&amp;only=scripts&amp;skin=vector&amp;version=ABKdjM61"></script><style>div.edittools-text { display:none; }</style><style>div.edittools-text { display:block; }</style></head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-Gamma_synth1_deconstructed skin-vector action-view">
		<div id="mw-page-base" class="noprint"></div>
		<div id="mw-head-base" class="noprint"></div>
		<div id="content" class="mw-body" role="main">
			<a id="top"></a>

						<div class="mw-indicators">
</div>
			<h1 id="firstHeading" class="firstHeading" lang="en">Gamma: synth1 deconstructed</h1>
									<div id="bodyContent" class="mw-body-content">
									<div id="siteSub">From cmwiki</div>
								<div id="contentSub"></div>
												<div id="jump-to-nav" class="mw-jump">
					Jump to:					<a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Gamma:_synth1_deconstructed#mw-head">navigation</a>, 					<a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Gamma:_synth1_deconstructed#p-search">search</a>
				</div>
				<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div style="border: outset 3px red; background-color: #ccc; padding:3px;">
<p><b>Disclaimer</b>
</p><p>The official website for Gamma is <a rel="nofollow" class="external free" href="http://mat.ucsb.edu/gamma">http://mat.ucsb.edu/gamma</a>.
</p><p>This is NOT an official gamma website.  Everything HERE is just random scribblings by people trying to understand gamma--and might be inaccurate, out of date, or just plain wrong.  You have been warned.
</p>
</div>
<p>In S12 MAT276AI, JoAnn Kuchera-Morin provided the following example file for doing synthesis with basic sine waves:
</p><p><a href="https://foo.cs.ucsb.edu/cmwiki/images/7/76/Synth1.cpp" class="internal" title="Synth1.cpp">Media:synth1.cpp</a>
</p><p>This page is an attempt to deconstruct and understand the code in this file.
</p><p>First, let's examine the main.  I've omitted many of the similar <code>s.add</code> lines—the ones I've left are enough to explain this part of the code.
</p>
<pre>int main(){

	Scheduler s;
	s.add&lt;SineEnv&gt;( 0  ).set(6.5, 260, 0.3, 1, 2);
	s.add&lt;SineEnv&gt;( 0  ).set(3.5, 510, 0.3, 1, 2);
	s.add&lt;SineEnv&gt;( 3.5).set(3.0, 233, 0.3, 1, 2);
	s.add&lt;SineEnv&gt;( 3.5).set(4.5, 340, 0.3, 1, 2);
// ...
	s.add&lt;SineEnv&gt;( 60.0).set(3.5, 230, 0.3, 1, 2);
	
	AudioIO io(256, 44100., s.audioCB, &amp;s);
	Sync::master().spu(io.fps());
	io.start();
	printf("\nPress 'enter' to quit...\n"); getchar();
}
</pre>
<p>First, the line:
</p>
<pre>	Scheduler s;
</pre>
<p>Simple enough: this creates an object of type <code>Scheduler</code>.   A deeper look reveals that a Scheduler is a special case of a more general object called a <code>Process</code>.    The type <code>Scheduler</code> is defined in <code>Gamma/Scheduler.h</code> as a subclass of <code>Process</code>:
</p>
<pre>class Scheduler&nbsp;: public Process{ 
...
</pre>
<p>And a <code>Process</code> is defined earlier in that same file as inheriting from Node3&lt;Process&gt; (a node that has a parent, a child, and right sibling of type &lt;Process&gt;:
</p>
<pre>// This defines a block-rate processing node in the audio graph
class Process&nbsp;: public Node3&lt;Process&gt;{
...
</pre>
<p>What do we do with a Schedule object?   In this example, we do two things: 
</p>
<ul><li> we use the add&lt;T&gt; method on it (which, in practice, at least in this example, adds notes that are going to be played)</li>
<li> we pass its <code>audioCB</code> member to the constructor of an <code>AudioIO</code> object, which is going to be used to playback the sound.</li></ul>
<p>Let's take a closer look at both of those methods.
</p>
<div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2><span class="toctoggle">&nbsp;[<a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Gamma:_synth1_deconstructed#" id="togglelink">hide</a>]&nbsp;</span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Gamma:_synth1_deconstructed#The_add.28.29_method_of_Scheduler"><span class="tocnumber">1</span> <span class="toctext">The add() method of Scheduler</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Gamma:_synth1_deconstructed#What_does_cmdAdd.28v.29_do.3F"><span class="tocnumber">1.1</span> <span class="toctext">What does cmdAdd(v) do?</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-3"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Gamma:_synth1_deconstructed#The_AudioIO_object"><span class="tocnumber">2</span> <span class="toctext">The AudioIO object</span></a></li>
<li class="toclevel-1 tocsection-4"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Gamma:_synth1_deconstructed#The_update.28.29_method_of_the_scheduler_.28called_from_inside_the_audioCB.28.29_function"><span class="tocnumber">3</span> <span class="toctext">The update() method of the scheduler (called from inside the audioCB() function</span></a></li>
<li class="toclevel-1 tocsection-5"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Gamma:_synth1_deconstructed#Meanwhile.2C_back_in_main"><span class="tocnumber">4</span> <span class="toctext">Meanwhile, back in main</span></a></li>
<li class="toclevel-1 tocsection-6"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Gamma:_synth1_deconstructed#The_SineEnv_class_from_synth1.cpp"><span class="tocnumber">5</span> <span class="toctext">The SineEnv class from synth1.cpp</span></a></li>
<li class="toclevel-1 tocsection-7"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Gamma:_synth1_deconstructed#Env.3C3.3E_mAmpEnv"><span class="tocnumber">6</span> <span class="toctext">Env&lt;3&gt; mAmpEnv</span></a></li>
<li class="toclevel-1 tocsection-8"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Gamma:_synth1_deconstructed#Pan.3C.3E_mPan"><span class="tocnumber">7</span> <span class="toctext">Pan&lt;&gt; mPan</span></a></li>
<li class="toclevel-1 tocsection-9"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Gamma:_synth1_deconstructed#Finally.2C_the_Osc.3C.3E"><span class="tocnumber">8</span> <span class="toctext">Finally, the Osc&lt;&gt;</span></a></li>
</ul>
</div>

<h1><span class="mw-headline" id="The_add.28.29_method_of_Scheduler">The add() method of Scheduler</span></h1>
<p>Inside the file Gamma/Scheduler.h, we find this curious definition for add():
</p>
<pre>template &lt;class AProcess, class A&gt;
        AProcess&amp; add(const A&amp; a){
                AProcess * v = new AProcess(a);
                cmdAdd(v); return *v;
        }
</pre>
<p>This method has two template parameters, <code>class AProcess</code>, and <code>class A</code>.   Compare this with the concrete invocation of this method in synth1.cpp:
</p>
<pre>	s.add&lt;SineEnv&gt;( 0  ).set(6.5, 260, 0.3, 1, 2);
</pre>
<p>What we see is that the actual value of <code>AProcess</code> is SineEnv, and the actual value of <code>A</code> is the integer literal 0.   Thus, inside the invocation of add, three things happen:
</p>
<ul><li> we create a new instance of AProcess (in this case SineEnv), passing in the parameter that is the integer literal 0 
<ul><li> in this case, that represents the point on the timeline at which the note should be played). </li></ul></li>
<li> A pointer to that new instance of SineEnv is passed to the method cmdAdd</li>
<li> A reference to that new object is returned as the result of the function call, which allows chaining of additional methods, such as the set() method we see in the line of code from synth1.cpp.</li></ul>
<p>In fact, inside Gamma/Scheduler.h, we see that there are many similar templates for the add method, each with a different number of parameters.  Thus, add is a very general function of the scheduler that can be used to add anything that is a Process, and any number of parameters can be passed into that Process objects constructor:
</p>
<pre>        template &lt;class AProcess, class A, class B, class C&gt;
        AProcess&amp; add(const A&amp; a, const B&amp; b, const C&amp; c){
                AProcess * v = new AProcess(a,b,c);
                cmdAdd(v); return *v;
        }

        template &lt;class AProcess, class A, class B, class C, class D&gt;
        AProcess&amp; add(const A&amp; a, const B&amp; b, const C&amp; c, const D&amp; d){
                AProcess * v = new AProcess(a,b,c,d);
                cmdAdd(v); return *v;
        }

        template &lt;class AProcess, class A, class B, class C, class D, class E&gt;
        AProcess&amp; add(const A&amp; a, const B&amp; b, const C&amp; c, const D&amp; d, const E&amp; e){
                AProcess * v = new AProcess(a,b,c,d,e);
                cmdAdd(v); return *v;
        }
...
</pre>
<h2><span class="mw-headline" id="What_does_cmdAdd.28v.29_do.3F">What does cmdAdd(v) do?</span></h2>
<p>But what about this cmdAdd(v) line of code? What does it do?  Well, the answer lies in src/Scheduler.cpp... and what seems to be happening is some kind of "deferred add" into a data structure.
</p>
<pre>void Scheduler::cmdAdd(Process * v){
        pushCommand(Command::ADD_FIRST_CHILD, this, v);
}

void Scheduler::pushCommand(Command::Type type, Process * object, Process * oth\
er){
        other-&gt;mDeletable=true;
        Command c = { type, object, other };
        mAddCommands.push(c);
}
</pre>
<p>mAddCommands is a queue of add operations that can either be ADD_FIRST_CHILD or ADD_LAST_CHILD, and which add operations into a linked data structure.    From the comments, it appears that the reason that the operations are deferred like this has to do with threading priorities: the operations are enqueued in a low priority thread, and are acted on (i.e. the nodes really get added into the tree) in a high priority thread by the method updateTree().
</p><p>But, we're getting a little lost in the weeds. Some of this will turn out to be important later, but for now, let's pop back up and look at another part of our synth1.cpp main code: the AudioIO object.
</p>
<h1><span class="mw-headline" id="The_AudioIO_object">The AudioIO object</span></h1>
<p>The definition of the AudioIO object is defined in Gamma/AudioIO.h this way:
</p>
<pre>/// Audio input/output streaming.                                               
/// This is a wrapper around the PortAudio v1.9 library.                        
                                                                             
class AudioIO&nbsp;: public AudioIOData {
public:
...
</pre>
<p>So, AudioIO inherits from AudioIOData, which is also defined in the same file, and is a base class:
</p><p><br>
</p>
<pre>/// Audio data to be sent to callback                                           
class AudioIOData {
public:

</pre>
<p>One of the overloaded operators defined on AudioIOData is the () operator—this is a rather ideosyncratic C++ idiom that, if you are not accustomed to it, can seem quite odd.    That is, you see an instance of an object followed by () and you say, "what the heck does that mean?"   
</p><p>And the answer is, someone Alice In Wonderland-like, "It means whatever we want it to mean", or more precisely, it means whatever the () operators was overloaded to mean.  For example, for class AudioIOData, the () operator means:
</p>
<pre>   /// Iterate frame counter, returning true while more frames         
   bool operator()() const { return (++mFrame)&lt;framesPerBuffer(); }
</pre>
<p>This operator is overloaded, however, in AudioIO, and the definition is in src/AudioIO.cpp
</p>
<pre>   void AudioIO::operator()(){ frame(0); if(callback) callback(*this); }
</pre>
<p>So, now that we know that AudioIO is an abstraction of an Audio Device, a wrapper around PortAudio, and inherits from AudioIOData, what are the parameters to the constructor invocation we see in synth1.cpp?
</p>
<pre>   AudioIO io(256, 44100., s.audioCB, &amp;s);
</pre>
<p>Here's the constructor:
</p>
<pre>   AudioIO(
                int framesPerBuf=64, double framesPerSec=44100.0,
                void (* callback)(AudioIOData &amp;) = 0, void * userData = 0,
                int outChans = 2, int inChans = 0 );
</pre>
<p>Thus we see that the 256 is the framesPerBuf (whatever that means), the 44100 is the framesPerSec (though we coudl have guessed that, the callback is a function (more on this in a minute) and we are passing in a pointer to our Scheduler through a void * (probably to be passed to that callback function.)   
</p><p>And, we see that we are accepting the default of 2 output channels, and 0 input channels.
</p><p>So, now what about this callback?   Well what we are passing in is the audioCB function of our scheduler object.   What does that function do?   
</p><p>Well, first of all, note that it is a <b><code>static</code></b> function.  So it has no <code>this</code> object.   Here's the definition in Gamma/Scheduler.h:
</p>
<pre>    static void audioCB(AudioIOData&amp; io){
                Scheduler&amp; s = io.user&lt;Scheduler&gt;();
		s.update(io);
        }
</pre>
<p>Ah, so now (sigh) we need to see what the "user" method of an AudioIOData is (and a templated method at that!)  Why here it is, from Gamma/AudioIO.h:
</p>
<pre>        template&lt;class UserDataType&gt;
        UserDataType&amp; user() const { return *(static_cast&lt;UserDataType *&gt;(mUser)); }
</pre>
<p>My best guess as to what that's doing is: return us the value of the mUser attribute of this AudioIOData object (which is, by the way, a void *), but cast it to whatever type we pass into the Template.  (So, one would assume, it has BETTER BE the type we're assuming.)  
</p><p>So, in short, the first line of code grabs a reference to the Scheduler that the AudioIOData object happens to be storing a pointer to inside its mUser private data member.   Then, it calls the update() method of that scheduler object, passing in the very same AudioIOData object.
</p><p>And what does s.update(io) do?   
</p>
<h1><span class="mw-headline" id="The_update.28.29_method_of_the_scheduler_.28called_from_inside_the_audioCB.28.29_function">The update() method of the scheduler (called from inside the audioCB() function</span></h1>
<p>Here's the declaration of the update() method in Gamma/Scheduler.h:
</p>
<pre>	template&lt;class UserDataType&gt;
        UserDataType&amp; user() const { return *(static_cast&lt;UserDataType *&gt;(mUser\
)); }
</pre>
<p>And here is the definition from inside src/Scheduler.cpp:
</p>
<pre>void Scheduler::update(AudioIOData&amp; io){
	updateTree();
	updateControlFuncs(io.secondsPerBuffer());

	// traverse tree                                                        
        Process * v = this;
	do{
                v = v-&gt;update(this, io);
	} while(v);

	// put nodes marked as 'done' into free list                            
        updateFreeList();
}
</pre>
<p>So updateTree() is the function that moves all of the deferred adds into the tree (see our earlier discussion of the Low Priority Thread and the High Priority Thread).    
</p><p>Then updateControlFuncs() is called to update a list of Func objects (we'll save that for another time, since it doesn't appear any of those are playing any visible role in the synth1.cpp file.)
</p><p>Then, we are traversing the tree, calling another function called update, but this time one with two parameters.  Presumably, each time that function is called, v gets updated until it is eventually null:
</p><p>The version of update with two parameters is declared in Gamma/AudioIO.h:
</p>
<pre>    /// Call processing algorithm, onProcessAudio()                         
    Process * update(const Process * top, AudioIOData&amp; io);
</pre>
<p>And defined in src/AudioIO.cpp:
</p>
<pre>Process * Process::update(const Process * top, AudioIOData&amp; io){
        double dt = io.secondsPerBuffer();
        int frame = 0;
        if(mDelay &gt;= dt){
                mDelay-=dt;
                return nextBreadth(top);
        }
        else if(mDelay &gt; 0){    // 0 &lt; delay &lt;= delta                           
                frame = mDelay * io.framesPerSecond();
                mDelay=0;
                if(frame &gt;= io.framesPerBuffer()) return nextBreadth(top);
        }
        return process(top, io, frame);
}
</pre>
<p>And here's why I stop and say---it's all sort of mystery from here.   Clearly something important is happening here.. and clearly all of the processes are getting traversed and computations are happening, but I've gotten lost in the weeds, and will probably need to come back before I can understand more.   So, let's pop WAY back up to the very top, back into the main of our synth1.cpp, and see where we left off..
</p>
<h1><span class="mw-headline" id="Meanwhile.2C_back_in_main">Meanwhile, back in main</span></h1>
<p>Remember back when we were looking at this line of code?
</p>
<pre>  AudioIO io(256, 44100., s.audioCB, &amp;s);
</pre>
<p>So, that was the constuctor for an AudioIO object.  We stored the callback function in <code>callback</code>, and we kept a pointer to a scheduler associated with that AudioIO object in <code>userdata</code>.
</p><p>The callback gets called when you invoke the () operator, for example:
</p>
<pre>    io();   // call callback 
</pre>
<p>because of this code:
</p>
<pre>void AudioIO::operator()(){ frame(0); if(callback) callback(*this); }
</pre>
<p>The mUser parameter of the parent AudioIOCallback object does indeed get filled in with the value of the userdata passed into the AudioIO constructor (you'll find that code in src/AudioIO.cpp in the constructor, if you really want to go looking for it.)
</p><p>Now that this io variable is set up as an instance of AudioIO, and has a deep relationship with our Scheduler object by means of various entangling alliances (void pointers, callback functions and the like) what's left to do?
</p><p>Three lines of code:
</p>
<pre>	Sync::master().spu(io.fps());
	io.start();
	printf("\nPress 'enter' to quit...\n"); getchar();\
</pre>
<p>Ok, let's unravel that first one.  In Gamma/Sync.h we find a Sync class, with a static method that instantiates a Sync object and returns it.   
</p>
<pre>  /// Master sync. By default, Synceds will be synced to this.            
        static Sync&amp; master(){
                static Sync * s = new Sync;
                return *s;
        }
</pre>
<p>The spu() method sets samples per unit, and it seems reasonable to get those from io.fps(). Finally, io.start(); sets the whole thing in motion, apparently, and we wait just so all our threads don't die when the end of main is reached.    A look inside the start() method reveals that it does indeed call the Pa_StartStream() method, which is a method of the underlying Port Audio library, rather than a method of Gamma.
</p><p>But still, what does any of this have to do with the rest of the code in the file?   Let's take a closer look.
</p>
<h1><span class="mw-headline" id="The_SineEnv_class_from_synth1.cpp">The SineEnv class from synth1.cpp</span></h1>
<p>Having unraveled the main from synth1.cpp---admittedly, only a little bit, but patience Grasshopper--let's now turn to the rest of the file.
</p><p>The first few lines of the class SineEnv are these:
</p>
<pre>class SineEnv&nbsp;: public Process {
public:

	SineEnv(double dt=0)
	:       Process(dt)
...
</pre>
<p>These tell us that SineEnv is a process, and that whatever parameter we pass in will be that processes "delay". Compare:
</p>
<pre>// This defines a block-rate processing node in the audio graph                 
class Process&nbsp;: public Node3&lt;Process&gt;{
public:

        Process(double delay=0.);
...
</pre>
<p>Before we continue with the methods of SineEnv, let's take a look at the instance variables:
</p>
<pre>protected:
        float mAmp;
	float mDur;
	Pan&lt;&gt; mPan;
	Sine&lt;&gt; mOsc;
        Env&lt;3&gt; mAmpEnv;
};
</pre>
<p>mAmp and mDur are straightforward: they are just simple floating point values for the Amplitude, and the Duration.  They get their initial values via the set() call in the constructor, and then can be altered only by calls to amp() and dur() respectively.
</p><p>The rest are a bit more subtle and involve some tricky C++.
</p>
<h1><span class="mw-headline" id="Env.3C3.3E_mAmpEnv">Env&lt;3&gt; mAmpEnv</span></h1>
<p>Let's start with Env&lt;3&gt; mAmpEnv;   The Env class is defined in Gamma/Envelope.h
</p>
<pre>/// Envelope with a fixed number of exponential segments and a sustain point    

/// The envelope consists of N exponential curve 'segments' and N+1 break-point
/// levels. The curvature and length of each segment and the break-point levels
/// can be controlled independently.                                            
/// This class can be used to construct many specialized envelopes such as an AD                                                                               
/// (Attack Decay), an ADSR (Attack Decay Sustain Release), and an ADSHR (Attack                                                                               
/// Decay Sustain Hold Release). The number of envelope segments is fixed to    
/// ensure better memory locality.                                              
///                                                                             
///    param N   number of segments                                              
///    param Tv  value (sample) type                                             
///    param Tp  parameter type                                                  
template &lt;int N, class Tv=real, class Tp=real, class Ts=Synced&gt;
class Env&nbsp;: public Ts{
public:

        Env()
...
</pre>
<p>So, an Env&lt;3&gt; has three segments.   What do we do with this mAmpEnv inside of the SineEnv class?
</p><p>Well, first the method calls inside the constructor set some parameters for the envelope:
</p>
<pre>                mAmpEnv.curve(0); // make segments lines                        
</pre>
<p>We learn in the comments of Gamma/Envelope.h that the value 0 here means "straight line". Other choices:
</p>
<pre> ///                                             c &gt; 0 approaches slowly (accelerates),                                                                 
 ///                                             c &lt; 0 approaches rapidly (decelerates), and                                                            
 ///                                             c = 0 approaches linearly                
</pre>
<p>Now, what about this?
</p>
<pre>                mAmpEnv.levels(0,1,1,0);
</pre>
<p>That just sets the levels for the four breakpoints (three segments means four breakpoints).   There are various methods for doing this, and those methods can be found in Gamma/Envelope.h, e.g.
</p>
<pre>        /// Set first two break-point levels                                    
        Env&amp; levels(Tv a, Tv b){ Tv v[]={a,b}; return levels(v,2); }

        /// Set first three break-point levels                                  
        Env&amp; levels(Tv a, Tv b, Tv c){ Tv v[]={a,b,c}; return levels(v,3); }

        /// Set first four break-point levels                                   
	Env&amp; levels(Tv a, Tv b, Tv c, Tv d){ Tv v[]={a,b,c,d}; return levels(v,4); }
</pre>
<p>Setting the attack and decay time works like this:
</p>
<pre>       SineEnv&amp; attack(float v){
                mAmpEnv.lengths()[0] = v;
                return *this;
        }
        SineEnv&amp; decay(float v){
                mAmpEnv.lengths()[2] = v;
                return *this;
        }
</pre>
<p>And apparently, it is also necessary to do this with the envelope at the top of the onProcess method of the SineEnv object so that the middle leg of the envelope has its length adjusted properly:
</p>
<pre>    mAmpEnv.totalLength(mDur, 1);
</pre>
<p>Here's the code for that method.  There is a different method there if you want to scale all of the segments proportionally.
</p>
<pre>       /// Set total length of envelope by adjusting one segment length       
        /// @param[in] length           desired length                         
        /// @param[in] modSegment       segment whose length is modified to match desired length                                                             
        Env&amp; totalLength(Tp length, int modSegment){
                mLengths[modSegment] = Tp(0);
                mLengths[modSegment] = length - totalLength();
                return *this;
        }
</pre>
<p>Now, the most "interesting" part of all is the operator() function, which is the one that may return a different value each time it is called, because it moves the envelope one "tick" of the clock through the various levels.  It returns the current amplitude level of the envelope, and the call looks like this: <code> mAmpEnv()</code>, as in:
</p>
<pre>  float s1 = mOsc() * mAmpEnv() * mAmp;
</pre>
<p><br>
</p>
<h1><span class="mw-headline" id="Pan.3C.3E_mPan">Pan&lt;&gt; mPan</span></h1>
<p>The Pan object is an odd duck--and its the () operator that makes it a bit weird.   Here's a portion of the class code, from Gamma/Effects.h (some parts omitted):
</p>
<pre>/// Equal-power 2-channel panner                                               
template &lt;class T=gam::real&gt;
class Pan{
public:

        /// @param[in] pos      Signed unit position in [-1, 1]                
        Pan(T pos=0){ this-&gt;pos(pos); }

        /// Filter sample (mono-to-stereo)                                     
        Vec&lt;2,T&gt; operator()(T in){
                return Vec&lt;2,T&gt;(in*w1, in*w2);
        }

        /// Filter sample (mono-to-stereo)                                     
        template &lt;class V&gt;
        void operator()(T in, V&amp; out1, V&amp; out2){
                out1 = in*w1; out2 = in*w2;
        }
</pre>
<p>So, when you see this in the code of the onProcess method, it's actually a call to the () operator of the Pan object called mPan, and the second and third paramters (s1 and s2) are being passed by reference, and CHANGED.    (So much for side-effect free functional programming.)    There are versions for stereo-to-stereo as well.
</p>
<pre>    mPan(s1, s1,s2);
</pre>
<p>Also, the Pan object has a pos method (think "setPos") to set the position of the pan between -1 and 1.
</p>
<pre>  SineEnv&amp; pan(float v){ mPan.pos(v); return *this; }
</pre>
<h1><span class="mw-headline" id="Finally.2C_the_Osc.3C.3E">Finally, the Osc&lt;&gt;</span></h1>
<p>The code for the Osc&lt;&gt; is found in Gamma/Oscillators.h.
</p><p>This is some of the hairiest code of all, involving multiple inheritance, templates, and all kinds of beasties:
</p>
<pre>
</pre>
<p>Let's just hope it works, and move on for now.  The crucial part is to know that that () operator is what gives us the current value, and that apparently, the onProcess() function is where the samples get computed.
</p>
<!-- 
NewPP limit report
Cached time: 20210401215708
Cache expiry: 86400
Dynamic content: false
CPU time usage: 0.225 seconds
Real time usage: 0.300 seconds
Preprocessor visited node count: 402/1000000
Preprocessor generated node count: 872/1000000
Post‐expand include size: 365/2097152 bytes
Template argument size: 0/2097152 bytes
Highest expansion depth: 2/40
Expensive parser function count: 0/100
-->

<!-- 
Transclusion expansion time report (%,ms,calls,template)
100.00%    7.204      1 - -total
100.00%    7.204      1 - Template:GammaDisclaimer
-->

<!-- Saved in parser cache with key cmwiki-mw_:pcache:idhash:6-0!*!*!!en!*!* and timestamp 20210401215708 and revision id 32
 -->
</div>					<div class="printfooter">
						Retrieved from "<a dir="ltr" href="https://foo.cs.ucsb.edu/cmwiki/index.php?title=Gamma:_synth1_deconstructed&amp;oldid=32">https://foo.cs.ucsb.edu/cmwiki/index.php?title=Gamma:_synth1_deconstructed&amp;oldid=32</a>"					</div>
				<div id="catlinks" class="catlinks catlinks-allhidden"></div>				<div class="visualClear"></div>
							</div>
		</div>
		<div id="mw-navigation">
			<h2>Navigation menu</h2>

			<div id="mw-head">
									<div id="p-personal" role="navigation" class="" aria-labelledby="p-personal-label">
						<h3 id="p-personal-label">Personal tools</h3>
						<ul>
							<li id="pt-login"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php?title=Special:UserLogin&amp;returnto=Gamma%3A+synth1+deconstructed" title="You are encouraged to log in; however, it is not mandatory [ctrl-option-o]" accesskey="o">Log in</a></li>						</ul>
					</div>
									<div id="left-navigation">
										<div id="p-namespaces" role="navigation" class="vectorTabs" aria-labelledby="p-namespaces-label">
						<h3 id="p-namespaces-label">Namespaces</h3>
						<ul>
															<li id="ca-nstab-main" class="selected"><span><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Gamma:_synth1_deconstructed" title="View the content page [ctrl-option-c]" accesskey="c">Page</a></span></li>
															<li id="ca-talk" class="new"><span><a href="https://foo.cs.ucsb.edu/cmwiki/index.php?title=Talk:Gamma:_synth1_deconstructed&amp;action=edit&amp;redlink=1" title="Discussion about the content page [ctrl-option-t]" accesskey="t" rel="discussion">Discussion</a></span></li>
													</ul>
					</div>
										<div id="p-variants" role="navigation" class="vectorMenu emptyPortlet" aria-labelledby="p-variants-label">
												<h3 id="p-variants-label" tabindex="0">
							<span>Variants</span><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Gamma:_synth1_deconstructed#" tabindex="-1"></a>
						</h3>

						<div class="menu">
							<ul>
															</ul>
						</div>
					</div>
									</div>
				<div id="right-navigation">
										<div id="p-views" role="navigation" class="vectorTabs" aria-labelledby="p-views-label">
						<h3 id="p-views-label">Views</h3>
						<ul>
															<li id="ca-view" class="selected"><span><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Gamma:_synth1_deconstructed">Read</a></span></li>
															<li id="ca-viewsource"><span><a href="https://foo.cs.ucsb.edu/cmwiki/index.php?title=Gamma:_synth1_deconstructed&amp;action=edit" title="This page is protected.
You can view its source [ctrl-option-e]" accesskey="e">View source</a></span></li>
															<li id="ca-history" class="collapsible"><span><a href="https://foo.cs.ucsb.edu/cmwiki/index.php?title=Gamma:_synth1_deconstructed&amp;action=history" title="Past revisions of this page [ctrl-option-h]" accesskey="h">View history</a></span></li>
													</ul>
					</div>
										<div id="p-cactions" role="navigation" class="vectorMenu emptyPortlet" aria-labelledby="p-cactions-label" style="">
						<h3 id="p-cactions-label" tabindex="0"><span>More</span><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Gamma:_synth1_deconstructed#" tabindex="-1"></a></h3>

						<div class="menu">
							<ul>
															</ul>
						</div>
					</div>
										<div id="p-search" role="search">
						<h3>
							<label for="searchInput">Search</label>
						</h3>

						<form action="https://foo.cs.ucsb.edu/cmwiki/index.php" id="searchform">
							<div id="simpleSearch">
							<input type="search" name="search" placeholder="Search" title="Search cmwiki [ctrl-option-f]" accesskey="f" id="searchInput" tabindex="1" autocomplete="off"><input type="hidden" value="Special:Search" name="title"><input type="submit" name="go" value="Go" title="Go to a page with this exact name if it exists" id="searchButton" class="searchButton">							</div>
						</form>
					</div>
									</div>
			</div>
			<div id="mw-panel">
				<div id="p-logo" role="banner"><a class="mw-wiki-logo" href="https://foo.cs.ucsb.edu/cmwiki/index.php/Main_Page" title="Visit the main page"></a></div>
						<div class="portal" role="navigation" id="p-navigation" aria-labelledby="p-navigation-label">
			<h3 id="p-navigation-label">Navigation</h3>

			<div class="body">
									<ul>
						<li id="n-mainpage-description"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Main_Page" title="Visit the main page [ctrl-option-z]" accesskey="z">Main page</a></li><li id="n-recentchanges"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Special:RecentChanges" title="A list of recent changes in the wiki [ctrl-option-r]" accesskey="r">Recent changes</a></li><li id="n-randompage"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Special:Random" title="Load a random page [ctrl-option-x]" accesskey="x">Random page</a></li><li id="n-help"><a href="https://www.mediawiki.org/wiki/Special:MyLanguage/Help:Contents" title="The place to find out">Help</a></li>					</ul>
							</div>
		</div>
			<div class="portal" role="navigation" id="p-tb" aria-labelledby="p-tb-label">
			<h3 id="p-tb-label">Tools</h3>

			<div class="body">
									<ul>
						<li id="t-whatlinkshere"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Special:WhatLinksHere/Gamma:_synth1_deconstructed" title="A list of all wiki pages that link here [ctrl-option-j]" accesskey="j">What links here</a></li><li id="t-recentchangeslinked"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Special:RecentChangesLinked/Gamma:_synth1_deconstructed" title="Recent changes in pages linked from this page [ctrl-option-k]" accesskey="k">Related changes</a></li><li id="t-specialpages"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Special:SpecialPages" title="A list of all special pages [ctrl-option-q]" accesskey="q">Special pages</a></li><li id="t-print"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php?title=Gamma:_synth1_deconstructed&amp;printable=yes" rel="alternate" title="Printable version of this page [ctrl-option-p]" accesskey="p">Printable version</a></li><li id="t-permalink"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php?title=Gamma:_synth1_deconstructed&amp;oldid=32" title="Permanent link to this revision of the page">Permanent link</a></li><li id="t-info"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php?title=Gamma:_synth1_deconstructed&amp;action=info" title="More information about this page">Page information</a></li>					</ul>
							</div>
		</div>
				</div>
		</div>
		<div id="footer" role="contentinfo">
							<ul id="footer-info">
											<li id="footer-info-lastmod"> This page was last modified on 11 May 2012, at 17:26.</li>
									</ul>
							<ul id="footer-places">
											<li id="footer-places-privacy"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Cmwiki:Privacy_policy" title="Cmwiki:Privacy policy">Privacy policy</a></li>
											<li id="footer-places-about"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Cmwiki:About" title="Cmwiki:About">About cmwiki</a></li>
											<li id="footer-places-disclaimer"><a href="https://foo.cs.ucsb.edu/cmwiki/index.php/Cmwiki:General_disclaimer" title="Cmwiki:General disclaimer">Disclaimers</a></li>
									</ul>
										<ul id="footer-icons" class="noprint">
											<li id="footer-poweredbyico">
							<a href="https://www.mediawiki.org/"><img src="https://foo.cs.ucsb.edu/cmwiki/resources/assets/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="/cmwiki/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /cmwiki/resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31"></a>						</li>
									</ul>
						<div style="clear:both"></div>
		</div>
		<script>window.RLQ = window.RLQ || []; window.RLQ.push( function () {
mw.loader.state({"user":"ready","user.groups":"ready"});mw.loader.load(["mediawiki.toc","mediawiki.action.view.postEdit","site","mediawiki.user","mediawiki.hidpi","mediawiki.page.ready","mediawiki.searchSuggest"]);
} );</script><script>window.RLQ = window.RLQ || []; window.RLQ.push( function () {
mw.config.set({"wgBackendResponseTime":1160});
} );</script>
	

<div class="suggestions" style="display: none; font-size: 13px;"><div class="suggestions-results"></div><div class="suggestions-special"></div></div></body></html>